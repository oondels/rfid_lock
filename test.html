<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script type="text/javascript">
      const generateImageBtn = document.querySelector("#generateImage");
      const imageContainer = document.querySelector(".print");
      const closeDialog = document.querySelector("#close-dialog");
      const overlay = document.querySelector(".overlay");
      let telaImage;

      document.addEventListener("DOMContentLoaded", () => {
        // Imagem
        const canvas = document.getElementById("labelCanvas");
        const ctx = canvas.getContext("2d");
        const scale = window.devicePixelRatio || 2;

        // Seleção de Tamanho da Etiqueta
        const tagSize = document.getElementById("tag-size");
        tagSize.addEventListener("change", () => {
          // Verifica Valor da Seleção de Tamanho da Etiqueta
          if (tagSize.value !== "Tamanho da Etiqueta para Impressão") {
            generateImageBtn.disabled = false;
          }
          if (tagSize.value === "Tamanho da Etiqueta para Impressão") {
            generateImageBtn.disabled = true;
          }

          const [width, height] = tagSize.value.split("-");
          // Define o tamanho da etiqueta
          canvas.width = width * scale;
          canvas.height = height * scale;
        });

        if (tagSize.value === "Tamanho da Etiqueta para Impressão") {
          generateImageBtn.disabled = true;
        }

        generateImageBtn.addEventListener("click", () => {
          if (imageContainer.classList.contains("showImage")) {
            imageContainer.classList.remove("showImage");
            overlay.classList.remove("showOverlay");
          } else {
            imageContainer.classList.add("showImage");
            overlay.classList.add("showOverlay");
          }

          // Informações Cadastro
          let barCode = document.getElementById("cadCodBarrasTela");
          cadCodBarrasTela.addEventListener("input", function () {
            if (cadCodBarrasTela.value.length > 7 || cadCodBarrasTela.value.length < 7)
              cadCodBarrasTela.value = cadCodBarrasTela.value.slice(0, 7);
          });

          const partesCalcadoTela = document.querySelectorAll(".partesCalcado");
          let pecaTela = "";
          for (let i = 0; i < partesCalcadoTela.length; i++) {
            if (partesCalcadoTela[i].checked) {
              if (pecaTela !== "") {
                pecaTela += " / ";
              }
              pecaTela += partesCalcadoTela[i].value;
            }
          }

          const marcaTela = document.getElementById("cadMarca").value;
          const modeloTela = document.getElementById("cadModelo").value;
          const numeroTela = document.getElementById("cadNumeroTela").value;
          const corTela = document.getElementById("cadCor").value;
          const fiosTela = document.getElementById("cadFios").value;
          const dataFabricacaoTela = document.getElementById("cadDataFabricacao").value;
          const usuarioTela = sessionStorage.getItem("usuario");

          ctx.imageSmoothingEnabled = false;
          ctx.scale(scale, scale);

          // Define um fundo branco
          ctx.fillStyle = "#FFFFFF";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Adiciona um texto na etiqueta
          ctx.fillStyle = "#000000";
          ctx.font = "bold 14px Arial";
          ctx.fillText(`${marcaTela} ${modeloTela}`, 10, 12);
          ctx.fillText(`N° ${numeroTela}`, 10, 28);
          ctx.fillText(`COR: ${corTela}`, 80, 28);
          ctx.fillText(`FIOS: ${fiosTela}`, 170, 28);
          ctx.fillText(`PEÇA: ${pecaTela}`, 10, 43);
          ctx.font = "12px Arial";
          ctx.fillText(`DATA: ${dataFabricacaoTela}`, 80, 57);

          // Cria código de barras
          const barcodeCanvas = document.createElement("canvas");
          JsBarcode(barcodeCanvas, barCode.value, {
            format: "CODE39",
            width: 2,
            height: h - 72,
            displayValue: true,
            fontSize: 12,
            margin: 8,
          });

          // Adiciona o Código de barras a imagem
          ctx.drawImage(barcodeCanvas, 1, 57);

          // Transforma o canvas em uma imagem
          const telaImage = canvas.toDataURL("image/png");

          // Exibe a imagem para o usuário
          const imagePreview = document.getElementById("imagePreview");
          imagePreview.src = telaImage;
        });

        closeDialog.addEventListener("click", () => {
          if (imageContainer.classList.contains("showImage")) {
            imageContainer.classList.remove("showImage");
            overlay.classList.remove("showOverlay");
          }
        });
      });
    </script>
  </body>
</html>
